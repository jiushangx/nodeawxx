<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Super Chat (v7.7 Final)</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    
    <style>
    /* --- åŠ¨ç”»ä¸åŠ è½½å™¨ --- */
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        .gemini-loader {
            width: 16px;
            height: 16px;
            border: 2px solid transparent;
            border-top-color: #8e8ea0;
            border-right-color: #8e8ea0;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            display: inline-block;
            margin-right: 8px;
            vertical-align: -2px;
        }

        /* çŠ¶æ€é¢œè‰² */
        .loader-blue { border-top-color: #4285f4; border-right-color: #4285f4; } /* æœç´¢/æ€è€ƒ */
        .loader-pink { border-top-color: #f48fb1; border-right-color: #f48fb1; } /* ç”»å›¾ */
        .loader-red  { border-top-color: #ff8a80; border-right-color: #ff8a80; } /* è§†é¢‘ */
        
        .thinking-state {
            display: flex;
            align-items: center;
            color: #8e8ea0;
            font-size: 14px;
            margin-bottom: 5px;
        }

        :root {
            --sidebar-bg: #202123;
            --main-bg: #343541;
            --chat-user: #343541;
            --chat-ai: #444654;
            --input-bg: #40414f;
            --text-color: #ececf1;
            --border-color: #4d4d4f;
            --active-item: #343541;
            --hover-item: #2a2b32;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--main-bg);
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* --- ä¾§è¾¹æ  --- */
        #sidebar {
            width: 260px;
            background-color: var(--sidebar-bg);
            display: flex;
            flex-direction: column;
            padding: 10px;
            border-right: 1px solid var(--border-color);
            transition: transform 0.3s ease;
            z-index: 50;
        }

        .new-chat-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            transition: 0.2s;
            margin-bottom: 10px;
            color: white;
            font-size: 14px;
        }
        .new-chat-btn:hover { background-color: var(--hover-item); }

        #history-list {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .history-item {
            padding: 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: #ccc;
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .history-item:hover { background-color: var(--hover-item); color: white; }
        .history-item.active { background-color: var(--active-item); color: white; font-weight: bold; }
        
        .delete-btn { opacity: 0; color: #888; font-size: 16px; padding: 0 5px; }
        .history-item:hover .delete-btn { opacity: 1; }
        .delete-btn:hover { color: #ff5555; }

        /* --- ä¸»ç•Œé¢ --- */
        #main-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            height: 100%;
        }

        #top-bar {
            height: 60px;
            background-color: var(--main-bg);
            border-bottom: 1px solid rgba(255,255,255,0.05);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 20px;
            gap: 10px;
            z-index: 10;
        }

        #sidebar-toggle {
            position: absolute;
            left: 15px;
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            display: none;
        }

        select {
            background: #202123;
            color: white;
            border: 1px solid #565869;
            padding: 8px 12px;
            border-radius: 6px;
            outline: none;
            font-size: 14px;
            min-width: 240px;
            text-align: center;
        }

        /* --- èŠå¤©åŒº --- */
        #chat-container {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            padding: 20px 0 140px;
            scroll-behavior: smooth;
        }

        .message-wrapper {
            width: 100%;
            padding: 24px 0;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            display: flex;
            justify-content: center;
        }

        .message-wrapper.ai { background-color: var(--chat-ai); }
        .message-wrapper.user { background-color: var(--chat-user); }

        .message-content {
            width: 100%;
            max-width: 800px;
            display: flex;
            gap: 20px;
            padding: 0 20px;
        }

        .avatar {
            width: 30px;
            height: 30px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 12px;
            flex-shrink: 0;
            color: #fff;
        }
        
        .avatar.user { background: #5436DA; }
        .avatar.gemini { background: linear-gradient(135deg, #4285f4, #d96570); }
        .avatar.deepseek { background: #4a90e2; }
        .avatar.kimi { background: #e84118; }
        .avatar.agg { background: #10a37f; }
        .avatar.mercury { background: #f59e0b; }

        .text { font-size: 16px; line-height: 1.6; width: 100%; overflow-wrap: break-word; }

        .generated-image { max-width: 100%; border-radius: 8px; margin-top: 10px; border: 1px solid #444; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .attachment-preview { max-width: 150px; max-height: 150px; border-radius: 6px; border: 1px solid #555; margin-bottom: 8px; display: block; }
        .pdf-badge { background: #333; color: #e57373; padding: 8px 12px; border-radius: 6px; font-size: 13px; display: inline-flex; align-items: center; gap: 6px; border: 1px solid #555; margin-bottom: 8px; }
        .yt-badge { background: rgba(255,0,0,0.15); color: #ff8a80; padding: 6px 10px; border-radius: 4px; font-size: 13px; display: inline-flex; align-items: center; gap: 6px; margin-bottom: 8px; border: 1px solid rgba(255,0,0,0.3); }
        .status-badge { font-size: 12px; padding: 3px 8px; border-radius: 12px; margin-bottom: 8px; display: inline-block; font-weight: bold; border: 1px solid rgba(255,255,255,0.1); }

        .text pre { background: #0d0d0d; padding: 15px; border-radius: 6px; overflow-x: auto; border: 1px solid #303030; margin: 15px 0; }

        /* --- è¾“å…¥åŒº --- */
        #input-area {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background-image: linear-gradient(180deg,rgba(53,55,64,0),var(--main-bg) 20%);
            padding: 20px 0 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 20;
        }

        #file-preview-bar { width: 90%; max-width: 800px; display: flex; gap: 10px; margin-bottom: 10px; overflow-x: auto; min-height: 0; }
        .file-chip { background: #40414f; padding: 6px 12px; border-radius: 20px; font-size: 13px; display: flex; align-items: center; gap: 8px; border: 1px solid #565869; color: white; flex-shrink: 0; }

        .input-box {
            width: 90%;
            max-width: 800px;
            background: var(--input-bg);
            border-radius: 12px;
            display: flex;
            padding: 12px;
            border: 1px solid rgba(255,255,255,0.1);
            align-items: flex-end;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
        }

        textarea { flex: 1; background: transparent; border: none; color: white; resize: none; outline: none; height: 24px; max-height: 200px; font-size: 16px; padding: 0 10px; line-height: 24px; }

        .icon-btn { background: transparent; border: none; color: #acacbe; cursor: pointer; padding: 6px; border-radius: 6px; transition: 0.2s; display: flex; align-items: center; justify-content: center; }
        .icon-btn:hover { color: white; background: #505260; }
        .icon-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .keys-manage { font-size: 12px; color: #666; margin-top: 10px; cursor: pointer; text-decoration: underline; }

        @media (max-width: 768px) {
            #sidebar { position: absolute; height: 100%; transform: translateX(-100%); }
            #sidebar.open { transform: translateX(0); }
            #sidebar-toggle { display: block; }
        }
    </style>
</head>
<body>

    <div id="sidebar">
        <div class="new-chat-btn" onclick="createNewSession()"><span>+</span> æ–°å»ºå¯¹è¯</div>
        <div id="history-list"></div>
        <div style="margin-top:auto; padding:10px; border-top:1px solid #333; font-size:12px; color:#666; text-align:center;">ğŸ”’ æ•°æ®å­˜å‚¨åœ¨æœ¬åœ° LocalStorage</div>
    </div>

    <div id="main-area">
        <div id="top-bar">
            <button id="sidebar-toggle" onclick="toggleSidebar()">â˜°</button>
            <select id="model-select"></select>
        </div>

        <div id="chat-container">
            <div class="message-wrapper ai">
                <div class="message-content">
                    <div class="avatar gemini">AI</div>
                    <div class="text">
                        <strong>AI è¶…çº§ç»ˆç«¯ (v7.7)</strong><br>
                        ğŸš€ <strong>æé€Ÿ</strong>ï¼šé›†æˆ Gemini 2.5 Flash<br>
                        âš¡ <strong>å…¨èƒ½</strong>ï¼šGemini 3 (è§†é¢‘/æœç´¢/æ–‡æ¡£)<br>
                        ğŸ¨ <strong>åˆ›ä½œ</strong>ï¼šæ–‡ç”Ÿå›¾ / DeepSeek ä»£ç 
                    </div>
                </div>
            </div>
        </div>

        <div id="input-area">
            <div id="file-preview-bar"></div>
            <div class="input-box">
                <button class="icon-btn" onclick="document.getElementById('file-input').click()" title="ä¸Šä¼ é™„ä»¶">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
                </button>
                <input type="file" id="file-input" hidden accept="image/*,application/pdf" onchange="handleFileSelect(this)">

                <textarea id="user-input" placeholder="è¾“å…¥æ¶ˆæ¯..." rows="1" oninput="autoResize(this)"></textarea>
                
                <button id="send-btn" class="icon-btn" onclick="handleSend()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                </button>
            </div>
            <div class="keys-manage" onclick="clearKeys()">[æ¸…é™¤ API Keys]</div>
        </div>
    </div>

<script>
        // ==================== 1. é…ç½®åŒºåŸŸ ====================
        const ENDPOINTS = {
            agg: "https://tensdaq-api.x-aio.com/v1/chat/completions",
            inception: "https://api.inceptionlabs.ai/v1/chat/completions",
            google: "https://generativelanguage.googleapis.com/v1beta/models"
        };

        const FIXED_AGG_KEY = "sk-ef5c51bead4c4420aebcd202811";

        // ğŸ› ï¸ å·¥å…·æ¨¡å‹ (ç”¨äºæœç´¢ã€ç”»å›¾ç­‰åå°ä»»åŠ¡)
        const WORKER_MODEL = "gemini-2.5-flash"; 

        const MODELS = [
            // ğŸŒŸ Google ä¸»æ¨¡å‹
            { id: "gemini-3-main",       model: "gemini-3-pro-preview",             name: "âš¡ Gemini 3 Pro (å…¨èƒ½ç‰ˆ)", type: "google-smart", keyName: "google_key", style: "gemini" },
            { id: "gemini-2.5-flash",    model: "gemini-2.5-flash",                 name: "ğŸš€ Gemini 2.5 Flash (æé€Ÿ)", type: "google-smart", keyName: "google_key", style: "gemini" },
            
            // ğŸ§© èšåˆæ¨¡å‹ (OpenAI æ ¼å¼)
            { id: "DeepSeek-V3.2-Exp",   model: "DeepSeek-V3.2-Exp",                name: "ğŸ”µ DeepSeek V3.2",         type: "agg",            keyName: "agg_key",    style: "deepseek" },
            { id: "Qwen3-235B",          model: "Qwen3-235B-A22B-Instruct-2507",    name: "ğŸŸ£ Qwen 3 (èšåˆ)",         type: "agg",            keyName: "agg_key",    style: "agg" },
            { id: "Kimi-K2-Instruct",    model: "Kimi-K2-Instruct",                 name: "ğŸ”´ Kimi K2 (èšåˆ)",        type: "agg",            keyName: "agg_key",    style: "kimi" },

            // ğŸ› ï¸ æ‰‹åŠ¨è¾“å…¥
            { id: "custom-agg",          model: "custom",                           name: "âœï¸ æ‰‹åŠ¨è¾“å…¥æ¨¡å‹ ID",        type: "agg",            keyName: "agg_key",    style: "agg" },
            
            // ğŸš€ å…¶ä»–
            { id: "mercury-coder",       model: "mercury-coder",                    name: "ğŸš€ Mercury Coder",         type: "inception",      keyName: "inception_key", style: "mercury" }
        ];

        // ==================== 2. åˆå§‹åŒ–ä¸çŠ¶æ€ ====================
        let currentSessionId = null;
        let history = [];
        let sessions = [];

        const modelSel = document.getElementById('model-select');
        modelSel.innerHTML = "";
        MODELS.forEach(m => modelSel.add(new Option(m.name, m.id)));
        
        const chatBox = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');

        marked.setOptions({ 
            highlight: (code, lang) => highlight.highlight(code, { language: highlight.getLanguage(lang) ? lang : 'plaintext' }).value,
            breaks: true 
        });

        function autoResize(elem) { elem.style.height = 'auto'; elem.style.height = Math.min(elem.scrollHeight, 200) + 'px'; }
        userInput.addEventListener('keydown', e => { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSend(); } });

        loadSessionsFromStorage();
        if (sessions.length === 0) createNewSession();
        else loadSession(sessions[0].id);

        // ==================== 3. ä¼šè¯å­˜å‚¨ç®¡ç† ====================
        function loadSessionsFromStorage() {
            const saved = localStorage.getItem('chat_sessions');
            sessions = saved ? JSON.parse(saved) : [];
            renderSidebar();
        }
        function saveSessionsToStorage() { localStorage.setItem('chat_sessions', JSON.stringify(sessions)); }
        
        function createNewSession() {
            const id = Date.now().toString();
            sessions.unshift({ id, title: "æ–°å¯¹è¯", timestamp: Date.now() });
            saveSessionsToStorage();
            loadSession(id);
        }
        
        function loadSession(id) {
            currentSessionId = id;
            const savedHistory = localStorage.getItem(`chat_history_${id}`);
            history = savedHistory ? JSON.parse(savedHistory) : [];
            chatBox.innerHTML = '';
            
            if (history.length > 0) {
                history.forEach(msg => {
                    let parts = msg.parts;
                    if (!parts && msg.content) parts = [{ text: msg.content }];
                    const role = (msg.role === 'model' || msg.role === 'assistant') ? 'assistant' : 'user';
                    let style = 'gemini';
                    if (role === 'user') style = 'user';
                    appendMsg(role, parts, style, false);
                });
            } else {
                chatBox.innerHTML = `<div class="message-wrapper ai"><div class="message-content"><div class="avatar gemini">AI</div><div class="text">æ–°çš„å¯¹è¯å¼€å§‹äº†ã€‚</div></div></div>`;
            }
            renderSidebar();
        }

        function deleteSession(e, id) {
            e.stopPropagation(); 
            if (!confirm("åˆ é™¤æ­¤ä¼šè¯ï¼Ÿ")) return;
            sessions = sessions.filter(s => s.id !== id); 
            saveSessionsToStorage(); 
            localStorage.removeItem(`chat_history_${id}`);
            if (currentSessionId === id) { 
                if (sessions.length > 0) loadSession(sessions[0].id); else createNewSession(); 
            } else renderSidebar();
        }

        function saveCurrentHistory() {
            if (!currentSessionId) return;
            localStorage.setItem(`chat_history_${currentSessionId}`, JSON.stringify(history));
            const session = sessions.find(s => s.id === currentSessionId);
            if (session && history.length > 0 && session.title === "æ–°å¯¹è¯") {
                const first = history.find(h => h.role === 'user');
                if (first && first.parts && first.parts[0].text) {
                    session.title = first.parts[0].text.substring(0, 15) || "å¯¹è¯";
                    saveSessionsToStorage(); 
                    renderSidebar();
                }
            }
        }

        function renderSidebar() {
            document.getElementById('history-list').innerHTML = sessions.map(s => `
                <div class="history-item ${s.id === currentSessionId ? 'active' : ''}" onclick="loadSession('${s.id}')">
                    <span>${s.title}</span><span class="delete-btn" onclick="deleteSession(event, '${s.id}')">Ã—</span>
                </div>`).join('');
        }
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }

        // ==================== 4. å‘é€ä¸å¤„ç†é€»è¾‘ ====================
        let currentFile = null;
        function handleFileSelect(input) {
            const file = input.files[0];
            if (!file) return;
            if (file.size > 10*1024*1024) { alert("æ–‡ä»¶è¿‡å¤§"); return; }
            const reader = new FileReader();
            reader.onload = e => { 
                currentFile = { mime: file.type, data: e.target.result.split(',')[1], name: file.name }; 
                renderFilePreview(); 
            };
            reader.readAsDataURL(file); 
            input.value = "";
        }

        function renderFilePreview() {
            const bar = document.getElementById('file-preview-bar');
            if (!currentFile) { bar.innerHTML = ""; return; }
            const icon = currentFile.mime.startsWith('image/') ? 'ğŸ–¼ï¸' : 'ğŸ“„';
            bar.innerHTML = `<div class="file-chip">${icon} ${currentFile.name} <span onclick="currentFile=null;renderFilePreview()">Ã—</span></div>`;
        }

        function getApiKey(keyName) {
            if (keyName === 'agg_key') return FIXED_AGG_KEY;
            let key = localStorage.getItem(keyName);
            if (!key) {
                key = prompt(`è¯·è¾“å…¥ ${keyName}:`); 
                if (key) localStorage.setItem(keyName, key.trim());
            }
            return key;
        }
        
        function clearKeys() { if(confirm("æ¸…é™¤ API Key?")) { localStorage.clear(); location.reload(); } }

        function appendMsg(role, contentParts, style, isTyping = false) {
            const div = document.createElement('div');
            div.className = `message-wrapper ${role === 'user' ? 'user' : 'ai'}`;
            let avatarLabel = 'AI';
            if (role === 'user') avatarLabel = 'U';
            else if (style.includes('gemini')) avatarLabel = 'G';
            else if (style.includes('img')) avatarLabel = 'ğŸ¨';
            else if (style.includes('deepseek')) avatarLabel = 'D';
            else if (style.includes('kimi')) avatarLabel = 'K';
            else if (style.includes('agg')) avatarLabel = 'Q';
            else if (style.includes('mercury')) avatarLabel = 'M';

            let contentHtml = "";
            if (isTyping) {
                // ğŸš€ Loading UI çŠ¶æ€
                contentHtml = `
                    <div class="thinking-state">
                        <div class="gemini-loader loader-blue"></div> 
                        <span>æ€è€ƒä¸­...</span>
                    </div>`;
            } else if (Array.isArray(contentParts)) {
                contentParts.forEach(part => {
                    if (part.text) contentHtml += marked.parse(part.text);
                    if (part.inline_data) {
                        const mime = part.inline_data.mime_type;
                        if (mime.startsWith('image/')) contentHtml += `<img src="data:${mime};base64,${part.inline_data.data}" class="generated-image">`;
                        else contentHtml += `<div class="pdf-badge">ğŸ“„ PDF æ–‡æ¡£</div>`;
                    }
                    if (part.file_data) contentHtml += `<div class="yt-badge">ğŸ¥ YouTube: ${part.file_data.file_uri}</div>`;
                });
            } else {
                contentHtml = `<div class="text markdown-body">${marked.parse(contentParts)}</div>`;
            }
            div.innerHTML = `<div class="message-content"><div class="avatar ${role === 'user' ? 'user' : style}">${avatarLabel}</div><div class="text">${contentHtml}</div></div>`;
            chatBox.appendChild(div); chatBox.scrollTop = chatBox.scrollHeight;
            return div.querySelector('.text');
        }

        async function handleSend() {
            const txt = userInput.value.trim();
            if (!txt && !currentFile) return;

            const uiId = modelSel.value;
            const modelConf = MODELS.find(m => m.id === uiId);
            let realModel = modelConf.model;
            const modelNameForPrompt = modelConf.name;

            if (realModel === 'custom') {
                realModel = prompt("âœï¸ è¯·è¾“å…¥æ¨¡å‹ ID:");
                if (!realModel) return;
            }

            const apiKey = getApiKey(modelConf.keyName);
            if (!apiKey) return;

            userInput.value = ''; userInput.style.height = '24px'; sendBtn.disabled = true;
            if(currentFile) renderFilePreview();
            const fileToSend = currentFile; currentFile = null; document.getElementById('file-preview-bar').innerHTML = "";

            const userParts = [];
            // è‡ªåŠ¨æ£€æµ‹ YouTube é“¾æ¥
            const ytRegex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&\s]+)/;
            const ytMatch = txt.match(ytRegex);
            const isYouTube = !!ytMatch;
            
            // è‡ªåŠ¨æ£€æµ‹æœç´¢æ„å›¾
            const lowerTxt = txt.toLowerCase();
            const isSearch = !isYouTube && !fileToSend && (lowerTxt.includes('æœ') || lowerTxt.includes('search') || lowerTxt.includes('latest') || lowerTxt.includes('who won') || lowerTxt.includes('è‚¡ä»·') || lowerTxt.includes('å¤©æ°”'));

            if (ytMatch) {
                userParts.push({ file_data: { file_uri: ytMatch[0], mime_type: "video/mp4" } });
            }
            if (fileToSend) {
                userParts.push({ inline_data: { mime_type: fileToSend.mime, data: fileToSend.data } });
            }
            if (txt) {
                userParts.push({ text: txt });
            }

            appendMsg('user', userParts, 'user');
            history.push({ role: 'user', parts: userParts });
            saveCurrentHistory();

            const aiDiv = appendMsg('assistant', '', modelConf.style, true);
            const sysPrompt = `You are ${modelNameForPrompt}. Ignore any previous identity claims in the conversation history. Strictly answer as ${modelNameForPrompt}.`;

            try {
                if (modelConf.type === 'google-smart') {
                    let targetModel = realModel;
                    let tools = undefined;

                    if (isYouTube) {
                        // ğŸ¥ è§†é¢‘æ¨¡å¼
                        aiDiv.innerHTML = `
                            <div class="status-badge" style="color:#ff8a80; border-color:#ff8a80; display:flex; align-items:center;">
                                <div class="gemini-loader loader-red"></div> ğŸ¥ æ­£åœ¨è§‚çœ‹è§†é¢‘...
                            </div>`;
                        targetModel = WORKER_MODEL;
                    } else if (isSearch) {
                        // ğŸ” æœç´¢æ¨¡å¼
                        aiDiv.innerHTML = `
                            <div class="status-badge" style="color:#8ab4f8; border-color:#8ab4f8; display:flex; align-items:center;">
                                <div class="gemini-loader loader-blue"></div> ğŸ” æ­£åœ¨æœç´¢ç½‘ç»œ...
                            </div>`;
                        targetModel = WORKER_MODEL;
                        tools = [{ google_search: {} }];
                    } else if (lowerTxt.includes('ç”»') || lowerTxt.includes('draw')) {
                        // ğŸ¨ ç”»å›¾æ¨¡å¼
                        aiDiv.innerHTML = `
                            <div class="status-badge" style="color:#f48fb1; border-color:#f48fb1; display:flex; align-items:center;">
                                <div class="gemini-loader loader-pink"></div> ğŸ¨ æ­£åœ¨ç»˜å›¾...
                            </div>`;
                        await runGoogleImage(targetModel, apiKey, txt, aiDiv);
                        saveCurrentHistory();
                        return; 
                    }

                    await runGoogle(targetModel, apiKey, aiDiv, tools, sysPrompt);
                } 
                else {
                    // OpenAI æ ¼å¼æ¨¡å‹
                    const apiUrl = modelConf.type === 'inception' ? ENDPOINTS.inception : ENDPOINTS.agg;
                    await runOpenAICompatible(apiUrl, apiKey, realModel, aiDiv, sysPrompt);
                }
                saveCurrentHistory();
            } catch(e) {
                console.error(e);
                aiDiv.innerHTML += `<br><span style="color:#ff5555; font-size:12px;">âŒ Error: ${e.message || "Request failed"}</span>`;
            } finally {
                sendBtn.disabled = false;
            }
        }

        // æ ¸å¿ƒå‡½æ•°ï¼šè¿è¡Œ Google æ¨¡å‹ (å«æœç´¢ä¿®æ­£)
        async function runGoogle(mid, key, ui, tools, sysPrompt) {
            let fullText = "";
            
            // ğŸš€ ä¼˜åŒ–ï¼šæœç´¢æ—¶æˆªæ–­å†å²ï¼Œæé«˜å“åº”é€Ÿåº¦
            let contextMessages = history;
            if (tools && tools.length > 0 && history.length > 5) {
                contextMessages = history.slice(-5); 
            }

            const cleanHistory = contextMessages.map(h => ({ role: h.role, parts: h.parts }));
            const bodyPayload = { contents: cleanHistory };
            
            // ğŸ› ï¸ ä¿®æ­£ï¼šä»…å‘é€ toolsï¼Œä¸å‘é€ configï¼Œé¿å…æŠ¥é”™
            if (tools) {
                bodyPayload.tools = tools;
            }
            
            if (sysPrompt) bodyPayload.system_instruction = { parts: [{ text: sysPrompt }] };

            const resp = await fetch(`${ENDPOINTS.google}/${mid}:streamGenerateContent?alt=sse`, {
                method: 'POST', 
                headers: { 'Content-Type': 'application/json', 'x-goog-api-key': key },
                body: JSON.stringify(bodyPayload)
            });

            if(!resp.ok) throw new Error((await resp.json()).error?.message);
            
            const reader = resp.body.getReader();
            const dec = new TextDecoder();
            
            // æ¸…é™¤ Loading
            const badge = ui.querySelector('.status-badge');
            const thinking = ui.querySelector('.thinking-state');
            if(badge) badge.remove();
            if(thinking) thinking.remove();

            while(true) {
                const {done, value} = await reader.read();
                if(done) break;
                const chunk = dec.decode(value, {stream:true});
                const lines = chunk.split('\n');
                for (const line of lines) {
                    if (line.startsWith('data:')) {
                        try {
                            const jsonStr = line.substring(5).trim();
                            if (!jsonStr) continue;
                            const data = JSON.parse(jsonStr);
                            const textPart = data.candidates?.[0]?.content?.parts?.[0]?.text;
                            if (textPart) {
                                fullText += textPart;
                                ui.innerHTML = marked.parse(fullText);
                                chatBox.scrollTop = chatBox.scrollHeight;
                            }
                        } catch(e) { }
                    }
                }
            }
            history.push({ role: 'model', parts: [{ text: fullText }] });
        }

        // æ ¸å¿ƒå‡½æ•°ï¼šè¿è¡Œç”»å›¾
        async function runGoogleImage(mid, key, prompt, ui) {
            const resp = await fetch(`${ENDPOINTS.google}/${mid}:generateContent`, {
                method: 'POST', 
                headers: { 'Content-Type': 'application/json', 'x-goog-api-key': key },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            if (!resp.ok) {
                const err = await resp.json();
                throw new Error(err.error?.message || "Image generation failed");
            }
            const json = await resp.json();
            const b64 = json.candidates?.[0]?.content?.parts?.[0]?.inline_data?.data;
            if (b64) {
                ui.innerHTML = `<img src="data:image/png;base64,${b64}" class="generated-image">`;
                history.push({ role: 'model', parts: [{ inline_data: { mime_type: "image/png", data: b64 } }] });
            } else {
                throw new Error("æœªè¿”å›å›¾ç‰‡æ•°æ®ï¼Œå¯èƒ½æ˜¯å®‰å…¨æ‹¦æˆªã€‚");
            }
        }

        // æ ¸å¿ƒå‡½æ•°ï¼šè¿è¡Œ OpenAI æ ¼å¼ API
        async function runOpenAICompatible(url, key, modelId, ui, sysPrompt) {
            const simpleHistory = history.map(h => {
                let cleanText = "";
                if (Array.isArray(h.parts)) {
                    h.parts.forEach(p => {
                        if (p.text) cleanText += p.text + "\n";
                        if (p.inline_data) cleanText += " [ç”¨æˆ·ä¸Šä¼ äº†å›¾ç‰‡] ";
                        if (p.file_data) cleanText += ` [è§†é¢‘é“¾æ¥: ${p.file_data.file_uri}] `;
                    });
                }
                return { role: h.role === 'model' ? 'assistant' : h.role, content: cleanText.trim() };
            }).filter(m => m.content.length > 0);

            const messagesToSend = [];
            if (sysPrompt) messagesToSend.push({ role: "system", content: sysPrompt });
            messagesToSend.push(...simpleHistory);

            const resp = await fetch(url, {
                method: 'POST', 
                headers: { 'Authorization': `Bearer ${key}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ model: modelId, messages: messagesToSend, stream: true })
            });

            if(!resp.ok) {
                const errText = await resp.text();
                let errMsg = errText;
                try { const errJson = JSON.parse(errText); errMsg = errJson.error?.message || errJson.message || errMsg; } catch(e){}
                throw new Error(errMsg);
            }
            
            const reader = resp.body.getReader();
            const dec = new TextDecoder();
            let fullText = "";

            const thinking = ui.querySelector('.thinking-state');
            if(thinking) thinking.remove();

            while(true) {
                const {done, value} = await reader.read();
                if(done) break;
                const lines = dec.decode(value).split('\n');
                for(const line of lines) {
                    if(line.startsWith('data: ') && !line.includes('[DONE]')) {
                        try { 
                            const json = JSON.parse(line.slice(6));
                            const delta = json.choices[0].delta.content;
                            if (delta) {
                                fullText += delta;
                                ui.innerHTML = marked.parse(fullText); 
                                chatBox.scrollTop = chatBox.scrollHeight; 
                            }
                        } catch(e){}
                    }
                }
            }
            history.push({ role: 'model', parts: [{ text: fullText }] });
        }
    </script>
</body>
</html>